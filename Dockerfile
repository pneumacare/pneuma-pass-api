FROM node:14-alpine as builder

RUN apk --no-cache add ca-certificates

WORKDIR /tmp

COPY package*.json ./
RUN npm install

COPY . .
RUN touch google-service-account.json
RUN npm run build
RUN npm prune --production

FROM alpine

ARG PORT=8000

ARG INPUT_ARG=ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAiZW1pbmVudC13b3JkaW5nLTI3NzkwOSIsCiAgInByaXZhdGVfa2V5X2lkIjogIjYyNDcyZWVmY2YyMTA4NWIzZWYxMzY1OTYyMDZhNjk2ODVkZTAwYTUiLAogICJwcml2YXRlX2tleSI6ICItLS0tLUJFR0lOIFBSSVZBVEUgS0VZLS0tLS1cbk1JSUV2UUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktjd2dnU2pBZ0VBQW9JQkFRQ3pETm1Tc3lYVS9KaWpcbmFhcSswRVVKMzdOUW9vZnB1MisxUDNha000UGFXanRoVFptVEpyeEFyYVpybStoN0JKT3YyRk1hZTZnVE56aUdcbkhSN2J5V01QemZtZ1NMS2Z5a1cyc3hZZC8rQ1Njb3NQNkJOU0tXQXhmNTRUSEtlMUc2ZGNyNjJ4WWxXS3pPajVcbnhKTCtKUTNoS3BMS3ZVeitNMUZQZ3duU1RiZUphbm1rUnNOa2k3c1JUeVhueFJvVmhvS09hUDlFRmtuYzRtb3lcbnZHNi9RQ29kZXFhVm9VY3VXMDV4ZmN5ekRCOEZhblVJZjMwVWtzTXJoQjR6ZmRubEVFTUZuVlZveC9US0RyNFVcbnVaeVZnQjR3bEx6SWgvaEticnRjdHZkdWN3NjIwZGJCYktUZnZWZHk4UHhXVVBGTXhqSUNkam5VeCtSOFMvV3lcbk9FRUhnZVZyQWdNQkFBRUNnZ0VBTWxmcm1SYnNEVDNVd1NYRno0OEp5bVB1ckQ1MnpwNVlJM01ycmJHYVlqdTZcbnRIbzRNeXJTQmJHTnVIWUc0UWdCYXBEOWxOV3VCWEVpWUhzeG9RUzM2TXEyWkgzc1U0ZHhJSlNzSkZVODFKQ0dcblR6dW1xeFJkS3EzQ1NZZG1GRU1wUktOVXlDcG8rUFR5a0wvWHdNTzBhbG9wR2Y0dDlzK0JEa1UrN3JYUlpENW1cbkZaL1AzcHk4ekQ4ZTJRT1Y4TjJMcTBNL0VZa2prK2E4WEo3Y3djQ3lyZ1VvYk1TSjUxODlwbzU1RFgvVVdxTTVcblZXZzhER2lQT1VkZnUwOWZyVnNyUXpGRUtKcnM4a3MyVmE3V0VRRkJOeUtLczFsUWhnUUJHUnRvbXNMb1lzaURcbitRczVkc3lkOXBSZnhST3hWd0oyb1lZbG5USzhQMStZclBnejJOYVR3UUtCZ1FEb2RhY3lLd2JLMGFOZUp5SVNcbi9JZEtmdnNKdUhHbDBxV1kyZk1KYU41cVdydU5CZm5uS0NuQng2OVpWanQrMXh0VUR3SUdUZW9OdHVXT0pmdXdcbmVmUUFMVmkzNnk0bld4RENOU1piV2V2VDQ0cEtsUmQ0ZE1wZW1nUHFmbnpIN1BFTE1GYk12NFdHYnJlZDRiaGFcbjNkdzFNeGlFZFdWS09jNENRQnl2dXZ0N0N3S0JnUURGTHBqU2psTldBejAxRW1xNHJtUk85VUhHb2d5Ujl3KzBcblk3c2pBVjNJblVDZytWSmw5U1V2UjVqNEppS1VuWjk0YnhqeHV5SXcramQrTVBKNFg4YXdDVHQ0RFR4ZDMxcU9cblNoMlo5QlZMWFlISlM2ZDE0Zi9KMFB6b2JOSjFqamx5bHlQSkVOMlN0SWY0QVRZS2pWNlVhQ2tiNVVjYVVod0lcbjZubXhZR0s3SVFLQmdRRFRtWVZBWFhvcFZQcm8wYVpxc2dSVkE1RndINzBUdk5PUWQ1U0xsREloamNYN2NOMHlcblZaVHRGOSs5Nm9qdHhORFRpM1hFVjFnZWM4WXh4dEY4cXdZNHd3NW5IR1UrM2Q0N2FqWW9JWXBScm1aTHpiczNcbm90Z3psTzdMbmFmb05QNlZ1TUxLVGV3MW1zTDVyR1lzRUpoS3RPQTBjc2hvOElWZDl3NGx5SWJ5VVFLQmdIMWZcbmdWL3ZpdUZYc2VVNnpveWFwY0RtaEdvTnd6eFVBTEpMNzBMMHJYTFBPYmFna0Ztdm8zTUtiU0xxN0hYZU92VlNcbmZtUEUvcHB4bmpNb1lDTlZrbmwvaFVaeDgvNGo4K29oQ2UxSG12cU9lK1ZIcXpSeS9EYVFJUjZQZ3Ntb0lyTFBcbmtydFhjK3JCeXVwUHF0TE96R0pFVUU4aVd6RkxIL1F6VWlrTUJmckJBb0dBS0ZqRUVMUXdYOXpGa081aDhMZlpcbkgrdHhBZk8vV3VlNmRtYks4WXp1eVVvZ0d4VXB2MEwyVHBhQ1NTeU1zRW9ubi9xQU9zajVFaUZTcFgwV0xVaGxcblJha0x6WFBMT2U4eC9VVUtXNHpQMHZlZ3BrRHZzdEJjTlVobUhaWkxkbGhjSFRUazZCbThSdit4V1A4TFd0MTRcbkV2RDRDVmRFQ2lZRWFVVmNlMW93SytZPVxuLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLVxuIiwKICAiY2xpZW50X2VtYWlsIjogImZpcmViYXNlLWFkbWluc2RrLXRqMTBxQGVtaW5lbnQtd29yZGluZy0yNzc5MDkuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICJjbGllbnRfaWQiOiAiMTEzODA3ODI3MTI2MjcyNjY2MjE5IiwKICAiYXV0aF91cmkiOiAiaHR0cHM6Ly9hY2NvdW50cy5nb29nbGUuY29tL28vb2F1dGgyL2F1dGgiLAogICJ0b2tlbl91cmkiOiAiaHR0cHM6Ly9vYXV0aDIuZ29vZ2xlYXBpcy5jb20vdG9rZW4iLAogICJhdXRoX3Byb3ZpZGVyX3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vb2F1dGgyL3YxL2NlcnRzIiwKICAiY2xpZW50X3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vcm9ib3QvdjEvbWV0YWRhdGEveDUwOS9maXJlYmFzZS1hZG1pbnNkay10ajEwcSU0MGVtaW5lbnQtd29yZGluZy0yNzc5MDkuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iCn0K
ENV INPUT_SERVICE_KEY $INPUT_ARG

RUN apk --no-cache add ca-certificates
RUN apk add --update nodejs

WORKDIR /app

COPY --from=builder /tmp/node_modules ./node_modules
COPY --from=builder /tmp/dist/ ./
COPY --from=builder /tmp/google-service-account.json google-service-account.json
RUN echo "$INPUT_SERVICE_KEY" | base64 -d > google-service-account.json
COPY package.json .

RUN ls -al

EXPOSE ${PORT}

ENTRYPOINT [ "node","server.js" ]



